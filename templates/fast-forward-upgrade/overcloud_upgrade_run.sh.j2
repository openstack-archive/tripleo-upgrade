#!/bin/env bash
#
# Run major upgrade on overcloud nodes
#
set -euo pipefail

{% if l3_agent_connectivity_check|bool %}
if [[ -e {{ working_dir }}/l3_agent_start_ping.sh ]]; then
    source {{ overcloud_rc }}
    bash {{ working_dir }}/l3_agent_start_ping.sh
fi
{% endif %}

{% if l3_agent_failover_check|bool %}
if [[ -e {{ working_dir }}/l3_agent_failover_pre.sh ]]; then
    source {{ overcloud_rc }}
    bash {{ working_dir }}/l3_agent_failover_pre.sh
fi
{% endif %}

{% if fip_http_check|bool %}
source {{ overcloud_rc }}
kill -9 $( lsof -t {{ working_dir }}/fip_http_check_start.sh ) || :
bash {{ working_dir }}/fip_http_check_start.sh &
{% endif %}

source {{ undercloud_rc }}

EXTERNAL_ANSWER=""
if openstack overcloud external-upgrade run --help | grep -qe "--yes"; then
    EXTERNAL_ANSWER="--yes"
fi

RUN_ANSWER=""
if openstack overcloud upgrade run --help | grep -qe "--yes"; then
    RUN_ANSWER="--yes"
fi

# Run the transfer data only if not doing the fast and furious upgrade
{% if transfer_data and not fast_and_furious -%}

if [ ! -f .system_upgrade_transfer_data ]; then

echo "[$(date)] Started upgrade transfer data for {{ hosts }}"

openstack overcloud external-upgrade run ${EXTERNAL_ANSWER} \
        --stack {{ overcloud_stack_name }} \
        --tags system_upgrade_transfer_data 2>&1 && touch .system_upgrade_transfer_data

if [ $? -ne 0 ]; then
    echo "[$(date)] Failed upgrade transfer data for {{ hosts }}"
    exit 1
else
    echo "[$(date)] Finished upgrade transfer data for {{ hosts }}"
fi


echo "[$(date)] Setting up hybrid state for computes"
openstack overcloud upgrade run ${RUN_ANSWER} \
        --stack {{ overcloud_stack_name }} \
        --playbook upgrade_steps_playbook.yaml \
        --tags nova_hybrid_state --limit all 2>&1

if [ $? -ne 0 ]; then
    echo "[$(date)] Failed setting up hybrid state for computes"
    exit 1
else
    echo "[$(date)] Finished setting up hybrid state for computes"
fi

fi

{% elif stop_services and not fast_and_furious -%}

echo "[$(date)] Started upgrade stop services for {{ hosts }}"

openstack overcloud external-upgrade run ${EXTERNAL_ANSWER} \
        --stack {{ overcloud_stack_name }} \
        --tags system_upgrade_stop_services 2>&1

if [ $? -ne 0 ]; then
    echo "[$(date)] Failed upgrade stop services for {{ hosts }}"
    exit 1
else
    echo "[$(date)] Finished upgrade stop services for {{ hosts }}"
fi
{% endif -%}

echo "[$(date)] Running major upgrade for {{ hosts }} hosts"

openstack overcloud upgrade run ${RUN_ANSWER} \
        --stack {{ overcloud_stack_name }} \
        {% if tripleo_upgrade_debug|bool %}
        --debug \
        {% endif -%}
        --limit {{ hosts }} --playbook all 2>&1

if [ $? -ne 0 ]; then
    echo "[$(date)] Failed major upgrade for {{ hosts }}"
    exit 1
else
    echo "[$(date)] Finished major upgrade for {{ hosts }} hosts"
fi
echo "[$(date)] Finished major upgrade for {{ hosts }} hosts"

{% if l3_agent_connectivity_check|bool %}
if [[ -e {{ working_dir }}/l3_agent_stop_ping.sh ]]; then
    source {{ overcloud_rc }}
    bash {{ working_dir }}/l3_agent_stop_ping.sh
fi
{% endif %}

{% if l3_agent_failover_check|bool %}
if [[ -e {{ working_dir }}/l3_agent_failover_post.sh ]]; then
    source {{ overcloud_rc }}
    bash {{ working_dir }}/l3_agent_failover_post.sh
fi
{% endif %}

{% if fip_http_check|bool %}
source {{ overcloud_rc }}
kill -9 $( lsof -t {{ working_dir }}/fip_http_check_start.sh )
bash {{ working_dir }}/fip_http_check_stop.sh
{% endif %}
{% if launch_sanity_workload|bool %}
#TODO (holser) Refactor neutron agent resilience
#When rabbit is restarted neutron agent waits 10 min to restore operations with
#rabbit. It means when controller-0 is upgraded and control is moved to it,
#all TCP connections will be dropped so that will innitiate timeout in neutron
#agent.
sleep 60

bash {{ working_dir }}/workload_launch.sh 'sanity'
{% endif %}
